name: Spring Boot Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AZURE_CONTAINER_REGISTRY: scholarai
  RESOURCE_GROUP: scholarai-rg
  CONTAINER_NAME: scholarai-spring
  IMAGE_NAME: scholarai-spring
  CONTAINER_GROUP_NAME: scholarai-stack

jobs:
    # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Setup Java
  #     uses: actions/setup-java@v4
  #     with:
  #       java-version: '21'
  #       distribution: 'corretto'
  #   
  #   - name: Cache Maven dependencies
  #     uses: actions/cache@v3
  #     with:
  #       path: ~/.m2
  #       key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
  #       restore-keys: ${{ runner.os }}-m2
  #   
  #   - name: Make mvnw executable
  #     run: chmod +x mvnw
  #   
  #   - name: Run tests
  #     run: ./mvnw clean test
  #   
  #   - name: Build application
  #     run: ./mvnw clean package -DskipTests

  build-and-deploy:
    # needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
    
    - name: Build and push Docker image
      run: |
        docker build \
          --build-arg ENV=prod \
          -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          -f docker/Dockerfile .
        
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: Deploy as Container Group (Simplified & Reliable)
      run: |
        # Clean up any existing containers first
        echo "üßπ Cleaning up existing containers..."
        for container in scholarai-stack scholarai-core-db scholarai-paper-db scholarai-rabbitmq scholarai-redis; do
          if az container show --resource-group ${{ env.RESOURCE_GROUP }} --name $container > /dev/null 2>&1; then
            echo "Deleting existing container: $container"
            az container delete --resource-group ${{ env.RESOURCE_GROUP }} --name $container --yes
          fi
        done
        
        # Wait for cleanup to complete
        echo "‚è≥ Waiting for cleanup to complete..."
        sleep 45
        
        # Use timestamp to ensure unique DNS names
        TIMESTAMP=$(date +%s)
        
        # Update the database hostnames in the API environment
        CORE_DB_HOST="scholarai-core-db-${TIMESTAMP}.eastus.azurecontainer.io"
        PAPER_DB_HOST="scholarai-paper-db-${TIMESTAMP}.eastus.azurecontainer.io"
        RABBITMQ_HOST="scholarai-rabbitmq-${TIMESTAMP}.eastus.azurecontainer.io"
        REDIS_HOST="scholarai-redis-${TIMESTAMP}.eastus.azurecontainer.io"
        
        # Create a simple container group with just the Spring Boot app first
        # This approach is more reliable than complex YAML
        echo "Creating container group with Spring Boot app..."
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name scholarai-stack-${TIMESTAMP} \
          --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --registry-login-server ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label scholarai-api-${TIMESTAMP} \
          --os-type Linux \
          --ports 8080 \
          --cpu 1 \
          --memory 2 \
          --environment-variables \
            SPRING_PROFILES_ACTIVE=prod \
            ENV=prod \
            CORE_DB_HOST=$CORE_DB_HOST \
            CORE_DB_PORT=5432 \
            CORE_DB_NAME=coreDB \
            CORE_DB_USER=${{ secrets.CORE_DB_USER }} \
            CORE_DB_PASSWORD=${{ secrets.CORE_DB_PASSWORD }} \
            PAPER_DB_HOST=$PAPER_DB_HOST \
            PAPER_DB_PORT=5432 \
            PAPER_DB_NAME=paperDB \
            PAPER_DB_USER=${{ secrets.PAPER_DB_USER }} \
            PAPER_DB_PASSWORD=${{ secrets.PAPER_DB_PASSWORD }} \
            RABBITMQ_HOST=$RABBITMQ_HOST \
            RABBITMQ_PORT=5672 \
            RABBITMQ_USER=${{ secrets.RABBITMQ_USER }} \
            RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }} \
            REDIS_HOST=$REDIS_HOST \
            REDIS_PORT=6379 \
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
            JWT_SECRET=${{ secrets.JWT_SECRET }} \
            JWT_ACCESS_EXPIRATION_MS=${{ secrets.JWT_ACCESS_EXPIRATION_MS }} \
            JWT_REFRESH_EXPIRATION_MS=${{ secrets.JWT_REFRESH_EXPIRATION_MS }} \
            SPRING_GOOGLE_CLIENT_ID=${{ secrets.SPRING_GOOGLE_CLIENT_ID }} \
            SPRING_GOOGLE_CLIENT_SECRET=${{ secrets.SPRING_GOOGLE_CLIENT_SECRET }} \
            SPRING_GITHUB_CLIENT_ID=${{ secrets.SPRING_GITHUB_CLIENT_ID }} \
            SPRING_GITHUB_CLIENT_SECRET=${{ secrets.SPRING_GITHUB_CLIENT_SECRET }} \
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }} \
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }} \
            SENDGRID_TEMPLATE_ID=${{ secrets.SENDGRID_TEMPLATE_ID }} \
          --restart-policy Always
        
        # Deploy the supporting services separately but with predictable FQDNs
        echo "Creating Core PostgreSQL Database..."
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name scholarai-core-db-${TIMESTAMP} \
          --image postgres:17-alpine \
          --registry-login-server index.docker.io \
          --registry-username ${{ secrets.DOCKER_HUB_USERNAME }} \
          --registry-password ${{ secrets.DOCKER_HUB_PASSWORD }} \
          --dns-name-label scholarai-core-db-${TIMESTAMP} \
          --os-type Linux \
          --ports 5432 \
          --cpu 0.5 \
          --memory 1 \
          --environment-variables \
            POSTGRES_USER=${{ secrets.CORE_DB_USER }} \
            POSTGRES_PASSWORD=${{ secrets.CORE_DB_PASSWORD }} \
            POSTGRES_DB=coreDB \
          --restart-policy Always &
        
        echo "Creating Paper PostgreSQL Database..."
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name scholarai-paper-db-${TIMESTAMP} \
          --image postgres:17-alpine \
          --registry-login-server index.docker.io \
          --registry-username ${{ secrets.DOCKER_HUB_USERNAME }} \
          --registry-password ${{ secrets.DOCKER_HUB_PASSWORD }} \
          --dns-name-label scholarai-paper-db-${TIMESTAMP} \
          --os-type Linux \
          --ports 5432 \
          --cpu 0.5 \
          --memory 1 \
          --environment-variables \
            POSTGRES_USER=${{ secrets.PAPER_DB_USER }} \
            POSTGRES_PASSWORD=${{ secrets.PAPER_DB_PASSWORD }} \
            POSTGRES_DB=paperDB \
          --restart-policy Always &
        
        echo "Creating RabbitMQ..."
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name scholarai-rabbitmq-${TIMESTAMP} \
          --image rabbitmq:3.12-alpine \
          --registry-login-server index.docker.io \
          --registry-username ${{ secrets.DOCKER_HUB_USERNAME }} \
          --registry-password ${{ secrets.DOCKER_HUB_PASSWORD }} \
          --dns-name-label scholarai-rabbitmq-${TIMESTAMP} \
          --os-type Linux \
          --ports 5672 15672 \
          --cpu 0.5 \
          --memory 1 \
          --environment-variables \
            RABBITMQ_DEFAULT_USER=${{ secrets.RABBITMQ_USER }} \
            RABBITMQ_DEFAULT_PASS=${{ secrets.RABBITMQ_PASSWORD }} \
          --restart-policy Always &
        
        echo "Creating Redis..."
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name scholarai-redis-${TIMESTAMP} \
          --image redis:7-alpine \
          --registry-login-server index.docker.io \
          --registry-username ${{ secrets.DOCKER_HUB_USERNAME }} \
          --registry-password ${{ secrets.DOCKER_HUB_PASSWORD }} \
          --dns-name-label scholarai-redis-${TIMESTAMP} \
          --os-type Linux \
          --ports 6379 \
          --cpu 0.25 \
          --memory 0.5 \
          --command-line "redis-server --requirepass ${{ secrets.REDIS_PASSWORD }}" \
          --restart-policy Always &
        
        # Wait for all background jobs to complete
        wait
        
        echo "‚úÖ All services deployed!"
        echo "üåê API: https://scholarai-api-${TIMESTAMP}.eastus.azurecontainer.io:8080"
        echo "üóÑÔ∏è Core DB: scholarai-core-db-${TIMESTAMP}.eastus.azurecontainer.io:5432"
        echo "üóÑÔ∏è Paper DB: scholarai-paper-db-${TIMESTAMP}.eastus.azurecontainer.io:5432"
        echo "üê∞ RabbitMQ UI: https://scholarai-rabbitmq-${TIMESTAMP}.eastus.azurecontainer.io:15672"
        echo "üì¶ Redis: scholarai-redis-${TIMESTAMP}.eastus.azurecontainer.io:6379" 